<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Package Management</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        :root {
            --primary-color: #6366F1;
            --primary-light: #eef2ff;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --border-color: #e5e7eb;
            --background-color: #f9fafb;
            --card-background: #ffffff;
            --text-heading: #1f2937;
            --text-body: #374151;
            --text-light: #6b7280;
        }

        *, *::before, *::after { box-sizing: border-box; }

        body {
            font-family: 'Sarabun', sans-serif;
            background-color: var(--background-color);
            color: var(--text-body);
            margin: 0;
            -webkit-font-smoothing: antialiased;
        }

        .container { 
            width: 100%; 
            max-width: 1100px;
            margin: 0 auto;
            padding: 30px;
            animation: fadeInPage 0.5s ease-out forwards;
        }

        .sticky-header {
            position: sticky;
            top: 0;
            background-color: var(--background-color);
            padding: 12px 0;
            z-index: 100;
            transition: box-shadow 0.2s ease-in-out;
            margin-bottom: 12px;
        }
        .sticky-header.scrolled {
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 36px;
        }
        
        .header-left, .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .select-all-group {
            display: flex;
            align-items: center;
        }
        .select-all-group label {
            font-weight: 600;
            color: var(--text-body);
            margin-left: 8px;
            user-select: none;
            cursor: pointer;
        }

        .bulk-actions-content {
            display: flex;
            align-items: center;
            gap: 16px;
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .bulk-actions-content.hidden {
            opacity: 0;
            transform: translateY(-10px);
            pointer-events: none;
            height: 0;
            overflow: hidden;
            padding: 0;
            margin: 0;
        }


        #edit-actions-left {
            display: flex;
            gap: 8px;
        }

        /* --- NEW: Adjust thickness of the Add New button icon --- */
        #add-new-btn {
            font-weight: 500; /* Adjust from 600 to 400 (normal weight) */
        }

        .bulk-actions-content .selection-count { font-weight: 600; color: var(--text-body); }
        .bulk-actions-content .bulk-buttons { display: flex; gap: 10px; }
        
        .btn {
            display: inline-flex; align-items: center; justify-content: center;
            gap: 8px; font-weight: 600; border: none; cursor: pointer;
            border-radius: 8px; padding: 10px 16px; font-size: 0.9rem;
            transition: all 0.2s ease; white-space: nowrap;
            background-color: #fff; border: 1px solid var(--border-color); color: var(--text-body);
            position: relative;
        }
        .btn:hover:not(:disabled) { background-color: #f9fafb; }
        .btn-primary { color: #fff; background-color: var(--primary-color); border-color: var(--primary-color); }
        .btn-primary:hover:not(:disabled) { background-color: #4f46e5; }
        .btn.btn-danger { color: #fff; background-color: var(--danger-color); border-color: var(--danger-color); }
        .btn.btn-danger:hover { background-color: #d92626; }
        .btn.btn-success { color: #fff; background-color: var(--success-color); border-color: var(--success-color); }
        .btn.btn-success:hover { background-color: #0e9f71; }
        .btn:disabled { cursor: not-allowed; opacity: 0.6; }
        
        .btn.btn-icon { padding: 7px; width: 36px; height: 36px; flex-shrink: 0; }
        .btn.btn-icon svg { display: block; margin: auto; }

        .btn.btn-loading {
            opacity: 0.8;
            pointer-events: none;
            color: transparent !important;
        }
        .btn.btn-loading::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            top: 50%;
            left: 50%;
            margin-top: -10px;
            margin-left: -10px;
            border: 3px solid rgba(255, 255, 255, 0.5);
            border-top-color: #ffffff;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        .btn:not(.btn-primary).btn-loading::after {
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-top-color: var(--primary-color);
        }
        
        #package-grid {
            padding-top: 12px;
            display: grid; 
            grid-template-columns: repeat(auto-fill, 290px);
            justify-content: center; 
            align-items: start; 
            align-content: start;
            gap: 20px;
        }

        .package-card {
            background-color: var(--card-background); border-radius: 12px; border: 1px solid var(--border-color);
            padding: 16px; transition: all 0.2s ease;
            display: flex; flex-direction: column; box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            position: relative;
            min-height: 150px;
        }
        .package-card.draggable { cursor: grab; }
        .package-card.selected-card {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px var(--primary-light);
            transform: translateY(-2px);
        }
        .card-checkbox { position: absolute; top: 12px; left: 12px; width: 20px; height: 20px; accent-color: var(--primary-color); }
        .pkg-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; cursor: pointer; padding-left: 28px; }
        .pkg-name { font-weight: 600; font-size: 1rem; color: var(--text-heading); word-break: break-word; flex-grow: 1; }
        .pkg-price { font-weight: 700; font-size: 1.1rem; color: var(--primary-color); white-space: nowrap; }
        .pkg-code { font-size: 0.8rem; color: var(--text-light); margin-top: 4px; margin-bottom: 12px; cursor: pointer; padding-left: 28px; }
        .pkg-footer { margin-top: auto; display: flex; justify-content: space-between; align-items: center; padding-top: 12px; border-top: 1px solid var(--border-color); }
        .pkg-info { display: flex; gap: 8px; align-items: center; }
        .info-tag { font-size: 0.8rem; font-weight: 600; padding: 4px 10px; border-radius: 16px; background-color: #f3f4f6; color: var(--text-light); }
        
        .status-toggle {
            font-weight: 600; background-color: transparent; border: none; cursor: pointer;
            padding: 5px; border-radius: 6px; transition: opacity 0.2s ease;
        }
        .status-toggle:hover { opacity: 0.7; }
        .status-toggle.active { color: var(--success-color); }
        .status-toggle.inactive { color: var(--danger-color); }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .modal-content { background-color: var(--card-background); border-radius: 12px; width: 90%; max-width: 600px; display: flex; flex-direction: column; overflow: hidden; }
        .modal-header { padding: 20px 24px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .modal-header h2 { font-size: 1.25rem; margin: 0; color: var(--text-heading); }
        .modal-body { padding: 24px; overflow-y: auto; }
        .modal-footer { padding: 16px 24px; background-color: var(--background-color); border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; align-items: center; gap: 10px; }
        .close-btn { background: transparent; border: none; cursor: pointer; color: #9ca3af; padding: 4px; display: flex; align-items: center; justify-content: center; }
        .close-btn:hover { color: var(--text-body); }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 8px; font-size: 0.9rem; }
        .form-group input, .form-group select { width: 100%; height: 42px; padding: 0 12px; border-radius: 8px; border: 1px solid #d1d5db; font-size: 1rem; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px var(--primary-light); }
        
        .modal-section { margin-bottom: 24px; }
        .modal-section:last-child { margin-bottom: 0; }
        .modal-section-title { font-size: 1.1rem; font-weight: 700; color: var(--text-heading); margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid var(--border-color); }
        .individual-edit-container { max-height: 280px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 8px; padding: 8px; background-color: var(--background-color); }
        .individual-edit-grid { display: grid; grid-template-columns: 1fr 80px 80px; align-items: center; gap: 5px; padding: 2px 4px; margin-bottom: 2px; }
        .individual-edit-grid .grid-header { font-weight: 600; color: var(--text-light); font-size: 0.8rem; text-transform: uppercase; padding-bottom: 8px; }
        .individual-edit-grid input { height: 38px; border-radius: 5px; border: 1px solid var(--border-color); padding: 0px 12px; }
        .modal-divider { border: 0; height: 1px; background-color: var(--border-color); margin: 24px 0; }
        .individual-edit-grid input[type="number"] { text-align: right; }

        .order-item { padding: 12px 16px; background-color: white; border: 1px solid var(--border-color); border-radius: 6px; cursor: grab; user-select: none; font-weight: 500; font-size: 1rem; margin-bottom: 8px; }
        .sortable-ghost { background: var(--primary-light); opacity: 0.6; }
        .toast { position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%); padding: 12px 24px; border-radius: 8px; color: #fff; font-weight: 600; box-shadow: 0 4px 20px rgba(0,0,0,0.15); transition: bottom 0.5s ease; z-index: 2000; }
        .toast.show { bottom: 20px; }
        .toast.success { background-color: var(--success-color); }
        .toast.error { background-color: var(--danger-color); }
        
        .hidden { display: none; }
        
        @keyframes fadeInPage {
            from { opacity: 0; transform: translateY(15px); }
            to   { opacity: 1; transform: translateY(0); }
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }

    </style>
</head>
<body>

    <div id="package-modal" class="modal-overlay hidden"></div>
    <div id="arrange-modal" class="modal-overlay hidden"></div>
    <div id="bulk-edit-modal" class="modal-overlay hidden"></div>

    <div class="container">
        <div class="sticky-header">
            <header class="page-header">
                <div class="header-left">
                    <div class="select-all-group">
                        <input type="checkbox" id="select-all-checkbox" title="Select All" style="width: 18px; height: 18px;">
                        <label for="select-all-checkbox">Select All</label>
                    </div>
                    <div id="bulk-actions-content" class="bulk-actions-content hidden">
                        <span id="selection-count" class="selection-count"></span>
                        <div class="bulk-buttons">
                            <button id="bulk-edit-btn" class="btn btn-icon" title="Bulk Edit" style="color: var(--primary-color); border-color: var(--primary-color);">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z"/><path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5v11z"/></svg>
                            </button>
                            <button id="bulk-delete-btn" class="btn btn-icon" title="Delete Selected" style="color: var(--danger-color); border-color: var(--danger-color);">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" />
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="header-right">
                    <button id="arrange-packages-btn" class="btn btn-icon" title="Arrange" style="color: var(--primary-color); border-color: var(--primary-color);">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                            <path d="M2 17l10 5 10-5"></path>
                            <path d="M2 12l10 5 10-5"></path>
                        </svg>
                    </button>
                    <button id="back-btn" class="btn btn-icon" title="Back to Games">
                         <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M10.354 4.646a.5.5 0 0 1 0 .708L6.707 8l3.647 3.646a.5.5 0 0 1-.708.708l-4-4a.5.5 0 0 1 0-.708l4-4a.5.5 0 0 1 .708 0z"></path></svg>
                    </button>
                    <button id="add-new-btn" class="btn btn-primary btn-icon" title="Add New Package" style="font-size: 1.5rem; line-height: 1; border-radius: 12px;">+</button>
                </div>
            </header>
        </div>

        <main>
            <div id="package-grid"></div>
        </main>
    </div>
    
    <div id="toast-notification" class="toast"></div>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {

        const closeIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/></svg>`;
        const packageTypes = ['UID', 'ID-PASS', 'RIOT#', 'OPEN/ID', 'CODE', 'QRCODE'];
        const packageChannels = ['RAZERGOLD', 'YOUTRIP', 'RICHMAN', '24BUYM', 'WEPAY', 'ITUNES', 'RAZERSILVER'];

        function generateSelectOptions(options, includeDefault = false) {
            let html = includeDefault ? '<option value="">-- Do not change --</option>' : '';
            html += options.map(opt => `<option value="${opt}">${opt}</option>`).join('');
            return html;
        }

        function createModalHTML({ title, body, footer, contentStyle = '' }) {
            return `
                <div class="modal-content" ${contentStyle ? `style="${contentStyle}"` : ''}>
                    <div class="modal-header">
                        <h2 id="pkg-modal-title">${title}</h2>
                        <button type="button" class="close-btn">${closeIcon}</button>
                    </div>
                    <div class="modal-body">${body}</div>
                    <div class="modal-footer">${footer}</div>
                </div>`;
        }

        const App = {
            gameName: new URLSearchParams(window.location.search).get('game'),
            allPackages: [],
            allGames: [],
            selectedPackageIds: new Set(),
            elements: {},
            API: {
                PACKAGES: '/api/packages',
                DASHBOARD_DATA: '/api/dashboard-data',
                BULK_ACTIONS: '/api/packages/bulk-actions',
                ORDER: '/api/packages/order'
            },
            
            init() {
                if (!this.gameName) {
                    window.location.href = new URL('/admin/packages', window.location.origin).href;
                    return;
                }
                document.title = `${this.gameName} - Packages`;
                this.cacheDOMElements();
                this.initEventListeners();
                this.buildModals();
                this.fetchAndRenderPackages();
            },

            cacheDOMElements() {
                this.elements = {
                    stickyHeader: document.querySelector('.sticky-header'),
                    packageGrid: document.getElementById('package-grid'),
                    toast: document.getElementById('toast-notification'),
                    addNewBtn: document.getElementById('add-new-btn'),
                    backBtn: document.getElementById('back-btn'),
                    selectAllCheckbox: document.getElementById('select-all-checkbox'),
                    bulkActionsContent: document.getElementById('bulk-actions-content'),
                    selectionCount: document.getElementById('selection-count'),
                    bulkEditBtn: document.getElementById('bulk-edit-btn'),
                    bulkDeleteBtn: document.getElementById('bulk-delete-btn'),
                    arrangePackagesBtn: document.getElementById('arrange-packages-btn'),
                };
            },

            initEventListeners() {
                window.addEventListener('scroll', () => {
                    this.elements.stickyHeader.classList.toggle('scrolled', window.scrollY > 10);
                });
                this.elements.addNewBtn.addEventListener('click', () => this.openEditModal());
                this.elements.backBtn.addEventListener('click', () => {
                    window.location.href = new URL('/admin/packages', window.location.origin).href;
                });
                this.elements.packageGrid.addEventListener('click', e => {
                    if (e.target.matches('.card-checkbox')) {
                        e.stopPropagation();
                        this.handleSelectionChange(e.target);
                    } else if (e.target.closest('.status-toggle')) {
                        e.stopPropagation();
                        this.handleStatusToggle(e.target.closest('.status-toggle'));
                    } else if (e.target.closest('.package-card')) {
                        this.handleCardClick(e.target.closest('.package-card'));
                    }
                });
                this.elements.selectAllCheckbox.addEventListener('change', (e) => this.handleSelectAll(e.target.checked));
                this.elements.bulkEditBtn.addEventListener('click', () => this.openBulkEditModal());
                this.elements.bulkDeleteBtn.addEventListener('click', (e) => this.handleBulkDelete(e.currentTarget));
                this.elements.arrangePackagesBtn.addEventListener('click', () => this.openArrangeModal());
            },

            async fetchAndRenderPackages(resetSelection = true) {
                try {
                    const response = await fetch(`${this.API.DASHBOARD_DATA}?game=${encodeURIComponent(this.gameName)}`);
                    if (!response.ok) throw new Error('Failed to fetch package data');
                    const data = await response.json();
                    this.allPackages = data.packages || [];
                    this.allGames = data.games || [];
                    if(resetSelection) {
                        this.selectedPackageIds.clear();
                    }
                    this.renderGrid();
                    this.updateHeaderState();
                } catch (error) { console.error(error); this.showToast('Could not load package data.', 'error'); }
            },

            renderGrid() {
                const grid = this.elements.packageGrid;
                grid.innerHTML = '';
                if (this.allPackages.length === 0) {
                    grid.innerHTML = `<p style="grid-column: 1 / -1; text-align: center; color: var(--text-light); padding: 40px;">No packages found. Click '+' to start.</p>`;
                    return;
                }
                this.allPackages.forEach(pkg => {
                    const isSelected = this.selectedPackageIds.has(pkg.id);
                    const statusClass = pkg.is_active ? 'active' : 'inactive';
                    const statusText = pkg.is_active ? 'Active' : 'Inactive';
                    const card = document.createElement('div');
                    card.className = 'package-card draggable';
                    card.dataset.id = pkg.id;
                    card.classList.toggle('selected-card', isSelected);
                    card.innerHTML = `
                        <input type="checkbox" class="card-checkbox" data-id="${pkg.id}" ${isSelected ? 'checked' : ''}>
                        <div class="pkg-header">
                            <span class="pkg-name">${pkg.name || ''}</span>
                            <span class="pkg-price">${(pkg.price || 0).toFixed(2)}฿</span>
                        </div>
                        <p class="pkg-code">${pkg.product_code || 'No code'}</p>
                        <div class="pkg-footer">
                            <div class="pkg-info">
                                <span class="info-tag">${pkg.type}</span>
                                <span class="info-tag">${pkg.channel}</span>
                            </div>
                            <button class="status-toggle ${statusClass}" data-id="${pkg.id}" data-status="${pkg.is_active}">${statusText}</button>
                        </div>
                    `;
                    grid.appendChild(card);
                });
                new Sortable(grid, { animation: 150, ghostClass: 'sortable-ghost', onEnd: () => this.handleSaveOrder(grid) });
            },
            
            updateHeaderState() {
                const count = this.selectedPackageIds.size;
                const hasSelection = count > 0;
                
                this.elements.bulkActionsContent.classList.toggle('hidden', !hasSelection);
                
                if (hasSelection) {
                    this.elements.selectionCount.textContent = `${count} item(s) selected`;
                }
                
                this.elements.selectAllCheckbox.checked = this.allPackages.length > 0 && count === this.allPackages.length;
            },

            handleSelectionChange(checkbox) {
                const packageId = parseInt(checkbox.dataset.id, 10);
                if (checkbox.checked) { this.selectedPackageIds.add(packageId); } 
                else { this.selectedPackageIds.delete(packageId); }
                checkbox.closest('.package-card').classList.toggle('selected-card', checkbox.checked);
                this.updateHeaderState();
            },
            
            handleSelectAll(isChecked) {
                if (isChecked) {
                    this.allPackages.forEach(pkg => this.selectedPackageIds.add(pkg.id));
                } else {
                    this.selectedPackageIds.clear();
                }
                this.renderGrid();
                this.updateHeaderState();
            },
            
            async handleBulkAction(action, payload = {}, buttonEl = null) {
                const ids = Array.from(this.selectedPackageIds);
                if (ids.length === 0) return;

                if (buttonEl) buttonEl.classList.add('btn-loading');
                try {
                    const response = await fetch(this.API.BULK_ACTIONS, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action, ids, ...payload })
                    });
                    if (!response.ok) { throw new Error((await response.json()).details || 'Bulk action failed'); }
                    
                    this.showToast('Bulk action completed!', 'success');
                    await this.fetchAndRenderPackages(false); 
                } catch (error) { 
                    this.showToast(`Error: ${error.message}`, 'error'); 
                } finally {
                    if (buttonEl) buttonEl.classList.remove('btn-loading');
                }
            },
            
            handleBulkDelete(buttonEl) {
                if (confirm(`Are you sure you want to delete ${this.selectedPackageIds.size} packages?`)) {
                    this.handleBulkAction('delete', {}, buttonEl);
                }
            },

            handleCardClick(card) {
                if (card) { this.openEditModal(parseInt(card.dataset.id, 10)); }
            },

            async handleStatusToggle(target) {
                const id = parseInt(target.dataset.id, 10);
                const newStatus = parseInt(target.dataset.status, 10) === 1 ? 0 : 1;
                try {
                    const pkgToUpdate = this.allPackages.find(p => p.id == id);
                    const response = await fetch(`${this.API.PACKAGES}/${id}`, {
                        method: 'PUT', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ ...pkgToUpdate, is_active: newStatus })
                    });
                    if (!response.ok) throw new Error('Failed to update status');
                    await this.fetchAndRenderPackages(false);
                    this.showToast('Status updated!');
                } catch (error) { this.showToast('Error updating status.', 'error'); }
            },

            async handleSaveOrder(container) {
                const items = container.querySelectorAll('.package-card, .order-item');
                const order = Array.from(items).map(item => parseInt(item.dataset.id, 10));
                
                const saveButton = this.elements.arrangeModal.querySelector('#save-arrange-btn');
                if (saveButton) saveButton.classList.add('btn-loading');

                try {
                    const response = await fetch(this.API.ORDER, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ order })
                    });
                    if (!response.ok) throw new Error('Failed to save order');
                    this.showToast('Order saved!', 'success');
                    await this.fetchAndRenderPackages(false);
                } catch (error) { 
                    console.error(error); this.showToast('Error saving order.', 'error'); 
                } finally {
                    if (saveButton) {
                        saveButton.classList.remove('btn-loading');
                        this.hideModal(this.elements.arrangeModal);
                    }
                }
            },

            buildModals() {
                const packageModalBody = `
                    <form id="package-form">
                        <input type="hidden" id="package-id"><input type="hidden" id="original-package-id">
                        <div class="form-grid">
                            <div class="form-group"><label for="name">Package Name</label><input type="text" id="name" required></div>
                            <div class="form-group"><label for="price">Price</label><input type="number" id="price" step="0.01" required></div>
                            <div class="form-group"><label for="product_code">CODE</label><input type="text" id="product_code"></div>
                            <div class="form-group">
                                <label for="type">Type</label>
                                <select id="type" required>${generateSelectOptions(packageTypes)}</select>
                            </div>
                            <div class="form-group">
                                <label for="channel">Channel</label>
                                <select id="channel" required>${generateSelectOptions(packageChannels)}</select>
                            </div>
                        </div>
                    </form>`;
                const packageModalFooter = `
                    <div id="edit-actions-left" style="margin-right:auto;"></div>
                    <button type="submit" form="package-form" class="btn btn-primary">Save Package</button>`;

                document.getElementById('package-modal').innerHTML = createModalHTML({
                    title: '',
                    body: packageModalBody,
                    footer: packageModalFooter
                });

                document.getElementById('arrange-modal').innerHTML = createModalHTML({
                    title: 'Arrange Packages',
                    body: '<div id="arrange-list-container" class="order-list-container"></div>',
                    footer: '<button type="button" id="save-arrange-btn" class="btn btn-primary">Save Order</button>',
                    contentStyle: 'max-width: 480px;'
                });

                const bulkEditModalBody = `
                    <div class="modal-section">
                        <h3 class="modal-section-title">Individual Edits</h3>
                        <div class="individual-edit-container">
                            <div class="individual-edit-grid" style="padding-top:0;">
                                <span class="grid-header">Package Name</span>
                                <span class="grid-header">Code</span>
                                <span class="grid-header">Price</span>
                            </div>
                            <div id="individual-edit-list"></div>
                        </div>
                    </div>
                    <hr class="modal-divider">
                    <div class="modal-section">
                        <h3 class="modal-section-title">Apply to All Selected</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="bulk-type">Change Type</label>
                                <select id="bulk-type">${generateSelectOptions(packageTypes, true)}</select>
                            </div>
                            <div class="form-group">
                                <label for="bulk-channel">Change Channel</label>
                                <select id="bulk-channel">${generateSelectOptions(packageChannels, true)}</select>
                            </div>
                            <div class="form-group">
                                <label for="bulk-game-association">Rename Game</label>
                                <input type="text" id="bulk-game-association">
                            </div>
                            <div class="form-group">
                                <label>Change Status</label>
                                <div style="display:flex; gap:10px;">
                                    <button type="button" id="bulk-set-active" class="btn btn-success" style="flex:1;">Set Active</button>
                                    <button type="button" id="bulk-set-inactive" class="btn btn-danger" style="flex:1;">Set Inactive</button>
                                </div>
                            </div>
                        </div>
                    </div>`;

                document.getElementById('bulk-edit-modal').innerHTML = createModalHTML({
                    title: 'Bulk Edit Packages',
                    body: bulkEditModalBody,
                    footer: '<button type="button" id="save-bulk-edit-btn" class="btn btn-primary">Save Changes</button>'
                });

                this.elements.packageModal = document.getElementById('package-modal');
                this.elements.arrangeModal = document.getElementById('arrange-modal');
                this.elements.bulkEditModal = document.getElementById('bulk-edit-modal');
                
                this.elements.packageModal.querySelector('.close-btn').addEventListener('click', () => this.hideModal(this.elements.packageModal));
                this.elements.packageModal.querySelector('#package-form').addEventListener('submit', (e) => this.handleFormSubmit(e));
                
                this.elements.arrangeModal.querySelector('.close-btn').addEventListener('click', () => this.hideModal(this.elements.arrangeModal));
                this.elements.arrangeModal.querySelector('#save-arrange-btn').addEventListener('click', () => this.handleSaveOrder(document.getElementById('arrange-list-container')));
                
                const bulkEditModal = this.elements.bulkEditModal;
                bulkEditModal.querySelector('.close-btn').addEventListener('click', () => this.hideModal(bulkEditModal));
                bulkEditModal.querySelector('#save-bulk-edit-btn').addEventListener('click', (e) => this.handleSaveBulkEdits(e.currentTarget));
                bulkEditModal.querySelector('#bulk-set-active').addEventListener('click', (e) => this.handleBulkAction('updateStatus', { status: 1 }, e.currentTarget));
                bulkEditModal.querySelector('#bulk-set-inactive').addEventListener('click', (e) => this.handleBulkAction('updateStatus', { status: 0 }, e.currentTarget));
            },
            
            openBulkEditModal() {
                const listContainer = this.elements.bulkEditModal.querySelector('#individual-edit-list');
                const gameInput = this.elements.bulkEditModal.querySelector('#bulk-game-association');
                gameInput.value = this.gameName;

                const selectedPackages = this.allPackages.filter(p => this.selectedPackageIds.has(p.id));
                listContainer.innerHTML = ''; 
                selectedPackages.forEach(pkg => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'individual-edit-grid';
                    itemDiv.innerHTML = `
                        <input type="text" data-id="${pkg.id}" data-type="name" value="${pkg.name || ''}">
                        <input type="text" data-id="${pkg.id}" data-type="code" value="${pkg.product_code || ''}">
                        <input type="number" step="0.01" data-id="${pkg.id}" data-type="price" value="${(pkg.price || 0).toFixed(2)}">
                    `;
                    listContainer.appendChild(itemDiv);
                });
                
                this.showModal(this.elements.bulkEditModal);
            },
            
            async handleSaveBulkEdits(buttonEl) {
                const modal = this.elements.bulkEditModal;
                const nameUpdates = [], priceUpdates = [], codeUpdates = [];
                
                modal.querySelectorAll('#individual-edit-list input').forEach(input => {
                    const id = parseInt(input.dataset.id, 10);
                    const type = input.dataset.type;
                    const originalPackage = this.allPackages.find(p => p.id === id);

                    if (type === 'name' && input.value !== originalPackage.name) nameUpdates.push({ id, newName: input.value });
                    else if (type === 'price' && parseFloat(input.value) !== originalPackage.price) priceUpdates.push({ id, newPrice: parseFloat(input.value) });
                    else if (type === 'code' && input.value !== (originalPackage.product_code || '')) codeUpdates.push({ id, newCode: input.value });
                });

                const updates = {};
                const newGameName = modal.querySelector('#bulk-game-association').value;
                const newType = modal.querySelector('#bulk-type').value;
                const newChannel = modal.querySelector('#bulk-channel').value;

                if (newGameName && newGameName !== this.gameName) updates.game_association = newGameName;
                if (newType) updates.type = newType;
                if (newChannel) updates.channel = newChannel;
                
                const promises = [];
                if (nameUpdates.length > 0) promises.push(this.handleBulkAction('setIndividualNames', { nameUpdates }));
                if (priceUpdates.length > 0) promises.push(this.handleBulkAction('setIndividualPrices', { priceUpdates }));
                if (codeUpdates.length > 0) promises.push(this.handleBulkAction('setIndividualCodes', { codeUpdates }));
                if (Object.keys(updates).length > 0) promises.push(this.handleBulkAction('bulkEdit', { updates }));

                if (promises.length > 0) {
                    buttonEl.classList.add('btn-loading');
                    try {
                        await Promise.all(promises);
                    } catch (e) {
                        /* Error handled in handleBulkAction */
                    } finally {
                        buttonEl.classList.remove('btn-loading');
                    }
                }
                
                this.hideModal(modal);
            },

            async handleFormSubmit(event) {
                event.preventDefault();
                const form = event.target;
                
                // ✨ BUG FIX: Correctly find the button associated with the form
                const saveButton = document.querySelector(`button[form="${form.id}"]`);

                const id = form.elements['package-id'].value;
                const originalId = form.elements['original-package-id'].value;

                const body = {
                    name: form.elements['name'].value,
                    price: parseFloat(form.elements['price'].value),
                    product_code: form.elements['product_code'].value,
                    type: form.elements['type'].value,
                    channel: form.elements['channel'].value,
                    game_association: this.gameName 
                };
                
                if (!id && originalId) body.originalId = originalId;
                const method = id ? 'PUT' : 'POST';
                const url = id ? `${this.API.PACKAGES}/${id}` : this.API.PACKAGES;

                if(saveButton) saveButton.classList.add('btn-loading');

                try {
                    const response = await fetch(url, {
                        method,
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(body)
                    });
                    if (!response.ok) throw new Error(`Failed to ${id ? 'update' : 'create'} package`);
                    this.hideModal(this.elements.packageModal);
                    this.showToast(`Package ${id ? 'updated' : 'created'} successfully!`);
                    await this.fetchAndRenderPackages(true);
                } catch (error) {
                    console.error(error);
                    this.showToast(error.message, 'error');
                } finally {
                    if(saveButton) saveButton.classList.remove('btn-loading');
                }
            },

            async handleDelete(id) {
                const deleteButton = this.elements.packageModal.querySelector('#delete-btn-modal');
                if (confirm('Are you sure you want to delete this package?')) {
                    if (deleteButton) deleteButton.classList.add('btn-loading');
                    try {
                        const response = await fetch(`${this.API.PACKAGES}/${id}`, { method: 'DELETE' });
                        if (!response.ok) throw new Error('Failed to delete package');
                        this.hideModal(this.elements.packageModal);
                        this.showToast('Package deleted!', 'success');
                        await this.fetchAndRenderPackages(true);
                    } catch (error) {
                        this.showToast('Error deleting data.', 'error');
                    } finally {
                        if (deleteButton) deleteButton.classList.remove('btn-loading');
                    }
                }
            },

            handleClone(id) {
                const pkgToClone = this.allPackages.find(p => p.id === id);
                if (!pkgToClone) return;
                const form = this.elements.packageModal.querySelector('#package-form');
                form.reset();
                this.elements.packageModal.querySelector('#pkg-modal-title').textContent = 'Clone Package';
                form.elements['package-id'].value = ''; 
                form.elements['original-package-id'].value = pkgToClone.id; 
                form.elements['name'].value = `${pkgToClone.name} - Clone`;
                form.elements['price'].value = pkgToClone.price;
                form.elements['product_code'].value = pkgToClone.product_code || '';
                form.elements['type'].value = pkgToClone.type;
                form.elements['channel'].value = pkgToClone.channel;
            },

            openEditModal(id = null) {
                const form = this.elements.packageModal.querySelector('#package-form');
                form.reset();
                
                const title = this.elements.packageModal.querySelector('#pkg-modal-title');
                const extraActions = this.elements.packageModal.querySelector('#edit-actions-left');
                
                form.elements['package-id'].value = '';
                form.elements['original-package-id'].value = '';

                if (id) {
                    const pkg = this.allPackages.find(p => p.id === id);
                    title.textContent = 'Edit Package';
                    form.elements['package-id'].value = pkg.id;
                    form.elements['name'].value = pkg.name;
                    form.elements['price'].value = pkg.price;
                    form.elements['product_code'].value = pkg.product_code || '';
                    form.elements['type'].value = pkg.type;
                    form.elements['channel'].value = pkg.channel;
                    extraActions.innerHTML = `<button type="button" id="clone-btn-modal" class="btn">Clone</button><button type="button" id="delete-btn-modal" class="btn btn-danger">Delete</button>`;
                    extraActions.querySelector('#clone-btn-modal').addEventListener('click', () => this.handleClone(id));
                    extraActions.querySelector('#delete-btn-modal').addEventListener('click', () => this.handleDelete(id));
                } else {
                    title.textContent = 'Add New Package';
                    extraActions.innerHTML = '';
                }
                this.showModal(this.elements.packageModal);
            },

            openArrangeModal() {
                const container = this.elements.arrangeModal.querySelector('#arrange-list-container');
                container.innerHTML = '';
                this.allPackages.forEach(pkg => {
                    const item = document.createElement('div');
                    item.className = 'order-item';
                    item.textContent = pkg.name;
                    item.dataset.id = pkg.id;
                    container.appendChild(item);
                });
                new Sortable(container, { animation: 150, ghostClass: 'sortable-ghost' });
                this.showModal(this.elements.arrangeModal);
            },

            showToast(message, type = 'success') { this.elements.toast.textContent = message; this.elements.toast.className = `toast ${type} show`; setTimeout(() => this.elements.toast.classList.remove('show'), 3000); },
            showModal(modalEl) { modalEl.classList.remove('hidden'); modalEl.classList.add('show'); },
            hideModal(modalEl) { modalEl.classList.remove('show'); modalEl.classList.add('hidden'); }
        };

        App.init();
    });
    </script>
</body>
</html>